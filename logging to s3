AWSTemplateFormatVersion: '2010-09-09'
Description: Creates an EC2 instance with Nginx installed. Write EC2 logs to S3 bucket

Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: nginx-logs-bucket-ust2

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource:
                  - !Sub arn:aws:s3:::nginx-logs-bucket-ust2/*

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0437df53acb2bbbfd # Amazon Linux 2023 AMI 
      InstanceType: t3.micro
      IamInstanceProfile: !Ref EC2InstanceProfile
      KeyName: !Ref KeyName
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      UserData: !Base64 |
        #!/bin/bash
        yum update -y
        yum install -y nginx
        service nginx start
        chkconfig nginx on
        mkdir -p /var/log/myapp
        echo "Logging started at $(date)" >> /var/log/myapp/log1.txt
        aws s3 cp /var/log/myapp/log1.txt s3://nginx-logs-bucket-ust2/log1.txt #Logfile
        
        echo "Log rotation initialized at $(date)" >> /var/log/myapp/log2.txt  #Logfile updated hourly
        cat <<EOF > /etc/cron.hourly/s3upload
        #!/bin/bash
        aws s3 cp /var/log/myapp/log2.txt s3://nginx-logs-bucket-ust2/$(date +\%Y-\%m-\%d_\%H-\%M).log.txt
        EOF
        chmod +x /etc/cron.hourly/s3upload
      
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and HTTP traffic
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0 # Replace with your IP for better security
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

Outputs:
  PublicIP:
    Description: Public IP address of the EC2 instance
    Value: !GetAtt WebServerInstance.PublicIp
  PublicDNS:
    Description: Public DNS name of the EC2 instance
    Value: !GetAtt WebServerInstance.PublicDnsName

  S3BucketName:
    Description: Name of the S3 bucket receiving logs
    Value: !Ref S3Bucket

 


 
